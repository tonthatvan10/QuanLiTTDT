@model TrungTamQuanLiDT.Models.KhoaHocModel
@{
    ViewData["Title"] = "Chi tiết khóa học";
}

<div class="container">
    <h1 class="my-4">@Model.TenKhoaHoc</h1>

    <!-- Thông báo -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Thông tin khóa học -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Thông tin khóa học</h5>
            <dl class="row">
                <dt class="col-sm-3">Tên khóa học</dt>
                <dd class="col-sm-9">@Model.TenKhoaHoc</dd>

                <dt class="col-sm-3">Giảng viên</dt>
                <dd class="col-sm-9">@Model.GiangVien</dd>

                <dt class="col-sm-3">Thời gian khai giảng</dt>
                <dd class="col-sm-9">@Model.ThoiGianKhaiGiang.ToString("dd/MM/yyyy HH:mm")</dd>

                <dt class="col-sm-3">Thời gian kết thúc</dt>
                <dd class="col-sm-9">@Model.ThoiGianKetThuc.ToString("dd/MM/yyyy HH:mm")</dd>

                <dt class="col-sm-3">Học phí</dt>
                <dd class="col-sm-9">@Model.HocPhi.ToString("N0") VNĐ</dd>

                <dt class="col-sm-3">Số lượng học viên tối đa</dt>
                <dd class="col-sm-9">@Model.SoLuongHocVienToiDa</dd>

                <dt class="col-sm-3">Số lượng đã đăng ký</dt>
                <dd class="col-sm-9">@Model.DangKyHocs.Count(d => d.TrangThai != DangKyKhoaHocModel.TrangThaiDangKy.DaHuy)</dd>
            </dl>
        </div>
    </div>

    <!-- Nút đăng ký/hủy đăng ký -->
    @if (User.Identity.IsAuthenticated && User.IsInRole(TrungTamQuanLiDT.Models.UserModel.UserRole.HocVien.ToString()))
    {
        @if (ViewBag.IsRegistered)
        {
            bool canCancel = Model.ThoiGianKhaiGiang > DateTime.Now &&
            Model.DangKyHocs.Any(d => d.MaHocVien == int.Parse(User.FindFirst("MaHocVien")?.Value ?? "0") && d.TrangThai == DangKyKhoaHocModel.TrangThaiDangKy.DangCho);
            @if (canCancel)
            {
                <form asp-action="CancelRegistration" asp-route-id="@Model.MaKhoaHoc" method="post">
                    <input type="hidden" name="__RequestVerificationToken" value="@Html.AntiForgeryToken()" />
                    <button type="submit" class="btn btn-danger">Hủy đăng ký</button>
                </form>
            }
            else
            {
                <div class="alert alert-info">
                    Bạn đã đăng ký khóa học này, nhưng không thể hủy vì khóa học đã khai giảng hoặc đăng ký đã được xác nhận.
                </div>
            }
        }
        else if (ViewBag.CanRegister)
        {
            <form asp-action="RegisterCourse" asp-route-id="@Model.MaKhoaHoc" method="post">
                <input type="hidden" name="__RequestVerificationToken" value="@Html.AntiForgeryToken()" />
                <button type="submit" class="btn btn-primary">Đăng ký khóa học</button>
            </form>
        }
        else
        {
            <div class="alert alert-warning">
                Không thể đăng ký do khóa học đã khai giảng hoặc đã đủ số lượng học viên.
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            Vui lòng <a asp-area="" asp-controller="Authentication" asp-action="Login">đăng nhập</a> với vai trò học viên để đăng ký khóa học.
        </div>
    }

    <!-- Nút quay lại -->
    <a asp-action="Privacy" asp-controller="Home" class="btn btn-secondary mt-3">Quay lại</a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
}